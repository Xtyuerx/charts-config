# 牙弓线坐标缩放问题说明

## 🐛 问题描述

牙弓线被缩放错误，跑到牙齿内部去了，应该在牙齿表面上。

## 🔍 问题原因

### 坐标系统差异

1. **牙齿中心点 (`centersUpper` / `centersLower`)**
   - 这些是从原始 STL 模型中提取的
   - 坐标是 **未缩放** 的原始坐标
   - 例如：`Vector3(10, 20, 30)`

2. **渲染的牙齿模型**
   - 牙齿 mesh 有 `scale = SCENE_CONFIG.modelScale = 1.5`
   - 实际渲染位置 = 原始坐标 × 1.5
   - 例如：原始 `(10, 20, 30)` → 渲染为 `(15, 30, 45)`

3. **牙弓线的位置**
   - 牙弓线添加到 `this.group`（没有父级缩放）
   - 如果直接使用未缩放的中心点创建牙弓线
   - 牙弓线会太小，陷入牙齿内部

### 示意图

```
未缩放坐标系 (原始数据):
  牙齿中心点: (10, 20, 30)
  
渲染坐标系 (显示时):
  牙齿 mesh (scale=1.5): (10×1.5, 20×1.5, 30×1.5) = (15, 30, 45)
  
错误做法 ❌:
  牙弓线 (未缩放): (10, 20, 30)  ← 太小！在牙齿内部
  
正确做法 ✅:
  牙弓线 (缩放后): (15, 30, 45)  ← 正确！与牙齿对齐
```

## ✅ 解决方案

### 方案：创建牙弓线前先缩放中心点

在 `MidlineAnalysisStrategy.ts` 的 `createArchWire()` 方法中：

```typescript
private createArchWire(): void {
  const { centersUpper, centersLower } = this.context

  // 1. 获取缩放系数
  const scale = SCENE_CONFIG.modelScale // 1.5

  // 2. 缩放上颌中心点
  const scaledUpperCenters: Record<number, THREE.Vector3> = {}
  Object.entries(centersUpper).forEach(([fdi, center]) => {
    scaledUpperCenters[Number(fdi)] = center.clone().multiplyScalar(scale)
  })

  // 3. 缩放下颌中心点
  const scaledLowerCenters: Record<number, THREE.Vector3> = {}
  Object.entries(centersLower).forEach(([fdi, center]) => {
    scaledLowerCenters[Number(fdi)] = center.clone().multiplyScalar(scale)
  })

  // 4. 使用缩放后的坐标创建牙弓线
  this.archWire = createMiddleArchWire(scaledUpperCenters, scaledLowerCenters)
  
  // 5. 添加到场景（this.group 没有父级缩放）
  this.group.add(this.archWire.group)
}
```

## 📊 元素添加位置对比表

| 元素类型 | 添加到 | 父级缩放 | 使用坐标 | 原因 |
|---------|--------|---------|---------|------|
| **牙弓线** | `this.group` | 无 | **缩放后** | group 直接添加到场景，需要手动缩放 |
| **控制点** | `archWire.group` | 无 | **缩放后** | 父级是 group，随牙弓线一起 |
| **垂直面** | `this.group` | 无 | **缩放后** | 父级是 group |
| **中线/标记/标签** | `upperMeshLabel` / `lowerMeshLabel` | **有 (1.5)** | **不缩放** | mesh 已有缩放，会继承 |
| **偏差线** | `this.group` | 无 | **缩放后** | 全局元素，添加到 group |

## 🎯 规律总结

### 何时使用缩放坐标？

✅ **添加到 `this.group` 的元素** → 使用 **缩放后** 的坐标
- 牙弓线
- 控制点（牙弓线的子元素）
- 垂直面
- 信息面板
- 跨颌的参考线

### 何时使用未缩放坐标？

✅ **添加到 `mesh` 的元素** → 使用 **未缩放** 的坐标
- 中线、标记、标签（通过 `addToMesh` 添加）
- 所有特定牙齿的点、线、标注

## 🔧 工具方法选择

| 用途 | 添加到 Group | 添加到 Mesh |
|------|-------------|-------------|
| 创建点位 | 坐标 × scale | 坐标（原始） |
| 创建线 | `LineRenderer.createLine()` | `this.createLineUnscaled()` |
| 计算中点 | 坐标 × scale | `this.getMidPointUnscaled()` |
| 计算中心 | 坐标 × scale | `this.calculatePointsCenterUnscaled()` |

## 📝 注意事项

1. **`SCENE_CONFIG.modelScale`** 是全局常量，值为 `1.5`
2. 牙齿中心点 (`centersUpper` / `centersLower`) 始终是 **未缩放** 的
3. 如果元素看起来太小或陷入模型内部 → 检查是否需要缩放
4. 如果元素看起来太大或飘浮在外面 → 检查是否多次缩放

## 🎉 验证方法

牙弓线正确显示的标志：
- ✅ 牙弓线在牙齿表面上（不在内部）
- ✅ 牙弓线大小与牙齿匹配
- ✅ 控制点可以沿着牙弓线拖动
- ✅ 垂直面正确对齐到牙弓线

---

**更新时间**: 2025-12-09  
**问题**: 牙弓线坐标缩放  
**解决**: 使用缩放后的中心点创建牙弓线

